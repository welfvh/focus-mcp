#!/bin/bash
# Focus Shield CLI - Simple interface to the daemon
# Usage: focus [command] [args]

SOCKET="/tmp/focusshield.sock"

case "$1" in
  status|s)
    curl -s --unix-socket $SOCKET http://localhost/status | jq .
    ;;

  grant|g)
    if [ -z "$2" ] || [ -z "$3" ]; then
      echo "Usage: focus grant <domain> <minutes> [reason]"
      exit 1
    fi
    REASON="${4:-Granted via CLI}"
    curl -s -X POST --unix-socket $SOCKET http://localhost/grant \
      -H "Content-Type: application/json" \
      -d "{\"domain\":\"$2\",\"minutes\":$3,\"reason\":\"$REASON\"}" | jq .
    ;;

  revoke|r)
    if [ -z "$2" ]; then
      echo "Usage: focus revoke <domain>"
      exit 1
    fi
    curl -s -X POST --unix-socket $SOCKET http://localhost/revoke \
      -H "Content-Type: application/json" \
      -d "{\"domain\":\"$2\"}" | jq .
    ;;

  block|b)
    if [ -z "$2" ]; then
      echo "Usage: focus block <domain>"
      exit 1
    fi
    # Get current list, add domain, send back
    CURRENT=$(curl -s --unix-socket $SOCKET http://localhost/status | jq -r '.blockedDomains // []')
    curl -s -X POST --unix-socket $SOCKET http://localhost/blocklist \
      -H "Content-Type: application/json" \
      -d "{\"domains\":$(curl -s --unix-socket $SOCKET http://localhost/status | jq '.blockedDomains + ["'$2'"]')}" | jq .
    ;;

  unblock|u)
    if [ -z "$2" ]; then
      echo "Usage: focus unblock <domain>"
      exit 1
    fi
    curl -s -X POST --unix-socket $SOCKET http://localhost/blocklist \
      -H "Content-Type: application/json" \
      -d "{\"domains\":$(curl -s --unix-socket $SOCKET http://localhost/status | jq '[.blockedDomains[] | select(. != "'$2'")]')}" | jq .
    ;;

  on|enable)
    curl -s -X POST --unix-socket $SOCKET http://localhost/enable | jq .
    ;;

  off|disable)
    curl -s -X POST --unix-socket $SOCKET http://localhost/disable | jq .
    ;;

  list|l)
    curl -s --unix-socket $SOCKET http://localhost/status | jq -r '.activeAllowances[] | "\(.domain) - \((.expiresAt - (now * 1000)) / 60000 | floor)m left"'
    ;;

  pulse|kill|k)
    echo "Pulsing pf to kill connections..."
    # Get IPs for common blocked sites
    IPS=$(dig +short youtube.com www.youtube.com twitter.com x.com | grep -E '^[0-9]' | head -10)
    RULES="# Pulse kill"
    for ip in $IPS; do
      RULES="$RULES\nblock return out quick proto tcp from any to $ip"
    done
    curl -s -X POST --unix-socket $SOCKET http://localhost/pf \
      -H "Content-Type: application/json" \
      -d "{\"rules\":\"$RULES\"}"
    sleep 3
    curl -s -X POST --unix-socket $SOCKET http://localhost/pf \
      -H "Content-Type: application/json" \
      -d '{"rules":"# cleared"}'
    echo "Done"
    ;;

  *)
    echo "Focus Shield CLI"
    echo ""
    echo "Commands:"
    echo "  focus status       - Show current status"
    echo "  focus grant <domain> <mins> [reason] - Grant temporary access"
    echo "  focus revoke <domain>  - Revoke access immediately"
    echo "  focus block <domain>   - Add domain to blocklist"
    echo "  focus unblock <domain> - Remove from blocklist"
    echo "  focus on/off       - Enable/disable shield"
    echo "  focus list         - Show active allowances"
    echo "  focus pulse        - Kill existing connections"
    echo ""
    echo "Shortcuts: s=status, g=grant, r=revoke, b=block, u=unblock, l=list, k=pulse"
    ;;
esac
