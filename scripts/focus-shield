#!/bin/bash
# Focus Shield CLI wrapper
# Simple interface for Claude to communicate with Focus Shield app
#
# Usage:
#   focus-shield status           - Get overall status
#   focus-shield check <domain>   - Check if domain is blocked
#   focus-shield grant <domain> <minutes> [reason] - Grant temporary access
#   focus-shield revoke <domain>  - Revoke access
#   focus-shield block <domain>   - Add domain to blocklist
#   focus-shield unblock <domain> - Remove from blocklist
#   focus-shield list             - List blocked domains
#   focus-shield passes           - List active passes

API="http://127.0.0.1:8053"

case "$1" in
  status)
    curl -s "$API/status" | python3 -m json.tool 2>/dev/null || curl -s "$API/status"
    ;;

  check)
    if [ -z "$2" ]; then
      echo "Usage: focus-shield check <domain>"
      exit 1
    fi
    curl -s "$API/api/check/$2"
    ;;

  grant)
    if [ -z "$2" ] || [ -z "$3" ]; then
      echo "Usage: focus-shield grant <domain> <minutes> [reason]"
      exit 1
    fi
    REASON="${4:-Granted via CLI}"
    curl -s -X POST "$API/api/grant" \
      -H "Content-Type: application/json" \
      -d "{\"domain\":\"$2\",\"minutes\":$3,\"reason\":\"$REASON\"}"
    ;;

  revoke)
    if [ -z "$2" ]; then
      echo "Usage: focus-shield revoke <domain>"
      exit 1
    fi
    curl -s -X DELETE "$API/api/grant/$2"
    ;;

  block)
    if [ -z "$2" ]; then
      echo "Usage: focus-shield block <domain>"
      exit 1
    fi
    curl -s -X POST "$API/api/block" \
      -H "Content-Type: application/json" \
      -d "{\"domain\":\"$2\"}"
    ;;

  unblock)
    if [ -z "$2" ]; then
      echo "Usage: focus-shield unblock <domain>"
      exit 1
    fi
    curl -s -X DELETE "$API/api/block/$2"
    ;;

  list)
    curl -s "$API/api/blocked"
    ;;

  passes|allowances)
    curl -s "$API/api/allowances"
    ;;

  dns-start)
    curl -s -X POST "$API/api/dns/start"
    ;;

  dns-stop)
    curl -s -X POST "$API/api/dns/stop"
    ;;

  *)
    echo "Focus Shield CLI"
    echo ""
    echo "Commands:"
    echo "  status              Get overall status"
    echo "  check <domain>      Check if domain is blocked"
    echo "  grant <d> <m> [r]   Grant access for m minutes"
    echo "  revoke <domain>     Revoke access"
    echo "  block <domain>      Add to blocklist"
    echo "  unblock <domain>    Remove from blocklist"
    echo "  list                List blocked domains"
    echo "  passes              List active passes"
    echo "  dns-start           Start DNS server"
    echo "  dns-stop            Stop DNS server"
    ;;
esac
